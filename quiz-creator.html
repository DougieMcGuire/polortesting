<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Creator - Polor</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    
    <style>
        :root {
            --primary-blue: #52C4F5;
            --primary-blue-dark: #3BA8D1;
            --success-green: #51CF66;
            --error-red: #FF6B6B;
            --white: #FFFFFF;
            --black: #000000;
            --gray-100: #F8F9FA;
            --gray-200: #E9ECEF;
            --gray-300: #DEE2E6;
            --gray-600: #6C757D;
            --gray-700: #495057;
            --gray-800: #343A40;
            --font-primary: 'Fredoka', sans-serif;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-2xl: 3rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-primary);
            background: linear-gradient(135deg, var(--primary-blue) 0%, #87CEEB 100%);
            min-height: 100vh;
            color: var(--black);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-xl);
        }

        .back-btn {
            background: var(--white);
            border: 2px solid var(--gray-300);
            border-radius: var(--radius-lg);
            padding: var(--spacing-sm) var(--spacing-md);
            font-family: var(--font-primary);
            font-weight: 500;
            color: var(--gray-700);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--spacing-lg);
        }

        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            background: var(--gray-100);
        }

        .header {
            text-align: center;
            margin-bottom: var(--spacing-2xl);
            color: var(--white);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: var(--spacing-sm);
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .creation-modes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-2xl);
        }

        .mode-card {
            background: var(--white);
            border: 3px solid var(--gray-300);
            border-radius: var(--radius-xl);
            padding: var(--spacing-xl);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
        }

        .mode-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-blue);
        }

        .mode-icon {
            font-size: 3rem;
            margin-bottom: var(--spacing-md);
        }

        .mode-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
            color: var(--gray-800);
        }

        .mode-desc {
            color: var(--gray-600);
            font-size: 0.95rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-lg);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--white);
            border: 3px solid var(--gray-300);
            border-radius: var(--radius-2xl);
            padding: var(--spacing-xl);
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: var(--shadow-xl);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-xl);
        }

        .modal-header h2 {
            color: var(--gray-800);
            font-size: 1.8rem;
        }

        .modal-close {
            background: var(--gray-200);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-600);
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: var(--error-red);
            color: var(--white);
        }

        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        .form-group label {
            display: block;
            margin-bottom: var(--spacing-sm);
            font-weight: 600;
            color: var(--gray-700);
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: var(--spacing-md);
            border: 2px solid var(--gray-300);
            border-radius: var(--radius-lg);
            font-family: var(--font-primary);
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-blue);
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
        }

        .questions-list {
            margin-top: var(--spacing-xl);
        }

        .question-item {
            background: var(--gray-100);
            border: 2px solid var(--gray-300);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
        }

        .question-image-preview {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: var(--radius-lg);
            margin-bottom: var(--spacing-md);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }

        .question-number {
            font-weight: 600;
            color: var(--primary-blue);
        }

        .answer-option {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
            align-items: center;
        }

        .answer-option input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .answer-option input[type="text"] {
            flex: 1;
            padding: var(--spacing-sm) var(--spacing-md);
            border: 2px solid var(--gray-300);
            border-radius: var(--radius-lg);
            font-family: var(--font-primary);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-md) var(--spacing-lg);
            border: 2px solid transparent;
            border-radius: var(--radius-lg);
            font-family: var(--font-primary);
            font-weight: 500;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--primary-blue);
            color: var(--white);
            border-color: var(--primary-blue);
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-blue-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: var(--gray-200);
            color: var(--gray-700);
            border-color: var(--gray-300);
        }

        .btn-secondary:hover {
            background: var(--gray-300);
        }

        .btn-danger {
            background: var(--error-red);
            color: var(--white);
        }

        .btn-small {
            padding: var(--spacing-sm) var(--spacing-md);
            font-size: 0.875rem;
        }

        .btn-large {
            padding: var(--spacing-lg) var(--spacing-xl);
            font-size: 1.1rem;
            min-width: 200px;
        }

        .preview-container {
            background: var(--gray-100);
            border: 3px solid var(--gray-300);
            border-radius: var(--radius-xl);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-lg);
        }

        .preview-header {
            text-align: center;
            margin-bottom: var(--spacing-xl);
        }

        .preview-header h3 {
            color: var(--gray-800);
            font-size: 1.5rem;
            margin-bottom: var(--spacing-sm);
        }

        .quiz-thumbnail-preview {
            width: 200px;
            height: 120px;
            object-fit: cover;
            border-radius: var(--radius-lg);
            margin: 0 auto var(--spacing-md);
            display: block;
            border: 3px solid var(--gray-300);
        }

        .preview-actions {
            display: flex;
            gap: var(--spacing-md);
            justify-content: center;
            margin-top: var(--spacing-xl);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            text-align: center;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--gray-300);
            border-top: 4px solid var(--primary-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto var(--spacing-md);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .notification-container {
            position: fixed;
            top: var(--spacing-lg);
            right: var(--spacing-lg);
            z-index: 10001;
            max-width: 400px;
        }

        .notification {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md) var(--spacing-lg);
            margin-bottom: var(--spacing-sm);
            box-shadow: var(--shadow-lg);
            border-left: 4px solid var(--primary-blue);
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .notification-success {
            border-left-color: var(--success-green);
        }

        .notification-error {
            border-left-color: var(--error-red);
        }

        @media (max-width: 768px) {
            .creation-modes {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="back-btn" id="back-to-dashboard">
            ‚Üê Back to Dashboard
        </button>

        <div class="header">
            <h1>üêª‚Äç‚ùÑÔ∏è Create Your Quiz</h1>
            <p>Choose how you want to create your quiz</p>
        </div>

        <div class="creation-modes">
            <div class="mode-card" id="magic-mode-btn">
                <div class="mode-icon">‚ú®</div>
                <div class="mode-title">Magic Quiz</div>
                <div class="mode-desc">Generate quizzes from any topic using AI</div>
            </div>

            <div class="mode-card" id="notes-mode-btn">
                <div class="mode-icon">üìù</div>
                <div class="mode-title">From Notes</div>
                <div class="mode-desc">Create quizzes from your study notes</div>
            </div>

            <div class="mode-card" id="manual-mode-btn">
                <div class="mode-icon">üîß</div>
                <div class="mode-title">Manual Creation</div>
                <div class="mode-desc">Build custom quizzes question by question</div>
            </div>

            <div class="mode-card" id="forms-mode-btn">
                <div class="mode-icon">üìã</div>
                <div class="mode-title">Google Forms</div>
                <div class="mode-desc">Import from Google Forms</div>
            </div>
        </div>
    </div>

    <!-- Magic Quiz Modal -->
    <div id="magic-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ú® Magic Quiz Generator</h2>
                <button class="modal-close" data-modal="magic-modal">&times;</button>
            </div>
            <form id="magic-quiz-form">
                <div class="form-group">
                    <label>Topic</label>
                    <input type="text" id="magic-topic" placeholder="e.g., World War II, Photosynthesis" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Number of Questions</label>
                        <select id="magic-count">
                            <option value="5">5 Questions</option>
                            <option value="10" selected>10 Questions</option>
                            <option value="15">15 Questions</option>
                            <option value="20">20 Questions</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Difficulty</label>
                        <select id="magic-difficulty">
                            <option value="easy">Easy</option>
                            <option value="medium" selected>Medium</option>
                            <option value="hard">Hard</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Tone</label>
                        <select id="magic-tone">
                            <option value="serious">Serious</option>
                            <option value="fun" selected>Fun</option>
                            <option value="educational">Educational</option>
                            <option value="humorous">Humorous</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Target Age</label>
                        <input type="number" id="magic-age" value="16" min="8" max="99">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary btn-large">Generate Quiz</button>
            </form>
        </div>
    </div>

    <!-- Notes Quiz Modal -->
    <div id="notes-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìù Quiz from Notes</h2>
                <button class="modal-close" data-modal="notes-modal">&times;</button>
            </div>
            <form id="notes-quiz-form">
                <div class="form-group">
                    <label>Your Notes</label>
                    <textarea id="notes-content" placeholder="Paste your study notes here..." required></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Number of Questions</label>
                        <select id="notes-count">
                            <option value="5">5 Questions</option>
                            <option value="10" selected>10 Questions</option>
                            <option value="15">15 Questions</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Difficulty</label>
                        <select id="notes-difficulty">
                            <option value="easy">Easy</option>
                            <option value="medium" selected>Medium</option>
                            <option value="hard">Hard</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary btn-large">Generate from Notes</button>
            </form>
        </div>
    </div>

    <!-- Manual Creation Modal -->
    <div id="manual-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üîß Manual Quiz Builder</h2>
                <button class="modal-close" data-modal="manual-modal">&times;</button>
            </div>
            <form id="manual-quiz-form">
                <div class="form-group">
                    <label>Quiz Title</label>
                    <input type="text" id="manual-title" placeholder="Enter quiz title" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Age Level</label>
                        <select id="manual-age">
                            <option value="Elementary">Elementary</option>
                            <option value="Middle School">Middle School</option>
                            <option value="High School" selected>High School</option>
                            <option value="College">College</option>
                            <option value="All Ages">All Ages</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Subject</label>
                        <input type="text" id="manual-subject" placeholder="e.g., Math, Science">
                    </div>
                </div>
                
                <div class="questions-list" id="manual-questions-list"></div>
                
                <button type="button" class="btn btn-secondary" id="add-question-btn">
                    + Add Question
                </button>
                <button type="button" class="btn btn-primary btn-large" id="save-manual-btn" style="margin-top: 1rem;">
                    Save Quiz
                </button>
            </form>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="preview-modal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>üìù Preview & Edit Quiz</h2>
                <button class="modal-close" data-modal="preview-modal">&times;</button>
            </div>
            
            <div class="preview-container">
                <div class="preview-header">
                    <input type="text" id="preview-title" placeholder="Quiz Title" style="width: 100%; max-width: 500px; padding: 0.75rem; border: 2px solid var(--gray-300); border-radius: var(--radius-lg); font-size: 1.2rem; font-weight: 600; text-align: center; font-family: var(--font-primary);">
                    <br><br>
                    <img id="preview-thumbnail" class="quiz-thumbnail-preview" src="" alt="Quiz Thumbnail">
                    <button type="button" class="btn btn-secondary btn-small" id="regenerate-thumbnail-btn">
                        üîÑ Regenerate Thumbnail
                    </button>
                </div>
                
                <div id="preview-questions-list"></div>
                
                <div class="preview-actions">
                    <button type="button" class="btn btn-secondary" id="preview-add-question-btn">
                        + Add Question
                    </button>
                    <button type="button" class="btn btn-primary btn-large" id="save-preview-btn">
                        Save Quiz
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p id="loading-text">Processing...</p>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container" class="notification-container"></div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        const CONFIG = {
            firebase: {
                apiKey: "AIzaSyBYcuke7uz4kAQzMjUpEqbY6zvwOiY9C1k",
                authDomain: "polorapi.firebaseapp.com",
                databaseURL: "https://polorapi-default-rtdb.firebaseio.com",
                projectId: "polorapi",
                storageBucket: "polorapi.firebasestorage.app",
                messagingSenderId: "945305666819",
                appId: "1:945305666819:web:a3c535e6cb9273882a1536",
                measurementId: "G-PQ0J44YZTN"
            },
            googleForms: {
                clientId: '232986823513-c8rsg486ajmis1stpci6r8ui55dah4t2.apps.googleusercontent.com',
                apiKey: 'AIzaSyB3k2fIHlqfsu-j8d5B28brLhBRUYr5r1A',
                scopes: 'https://www.googleapis.com/auth/drive.readonly https://www.googleapis.com/auth/forms.body.readonly'
            }
        };

        firebase.initializeApp(CONFIG.firebase);
        const auth = firebase.auth();
        const database = firebase.database();

        let currentUser = null;
        let manualQuestions = [];
        let previewQuestions = [];
        let currentPreviewData = {};
        let gapiInited = false;
        let pickerApiLoaded = false;
        let tokenClient = null;
        let accessToken = '';

        // Wait for DOM to be ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, setting up listeners...');
            setupEventListeners();
        });

        // Check auth
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                console.log('User authenticated:', user.email);
            } else {
                console.log('No user found');
                // Comment out redirect for testing
                // window.location.href = 'auth.html';
            }
        });

        function setupEventListeners() {
            // Back button
            document.getElementById('back-to-dashboard').addEventListener('click', () => {
                window.location.href = 'dashboard.html';
            });

            // Mode cards
            document.getElementById('magic-mode-btn').addEventListener('click', () => {
                console.log('Magic clicked');
                openModal('magic-modal');
            });

            document.getElementById('notes-mode-btn').addEventListener('click', () => {
                console.log('Notes clicked');
                openModal('notes-modal');
            });

            document.getElementById('manual-mode-btn').addEventListener('click', () => {
                console.log('Manual clicked');
                openModal('manual-modal');
            });

            document.getElementById('forms-mode-btn').addEventListener('click', () => {
                console.log('Forms clicked');
                handleGoogleFormsImport();
            });

            // Modal close buttons
            document.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', function() {
                    const modalId = this.getAttribute('data-modal');
                    closeModal(modalId);
                });
            });

            // Close modals on outside click
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.remove('active');
                    }
                });
            });

            // Form submissions
            document.getElementById('magic-quiz-form').addEventListener('submit', handleMagicQuiz);
            document.getElementById('notes-quiz-form').addEventListener('submit', handleNotesQuiz);

            // Manual quiz buttons
            document.getElementById('add-question-btn').addEventListener('click', addManualQuestion);
            document.getElementById('save-manual-btn').addEventListener('click', saveManualQuiz);

            // Preview modal buttons
            document.getElementById('preview-add-question-btn').addEventListener('click', addPreviewQuestion);
            document.getElementById('save-preview-btn').addEventListener('click', savePreviewQuiz);
            document.getElementById('regenerate-thumbnail-btn').addEventListener('click', regenerateThumbnail);

            console.log('All event listeners set up!');
        }

        function openModal(modalId) {
            console.log('Opening modal:', modalId);
            document.getElementById(modalId).classList.add('active');
            if (modalId === 'manual-modal' && manualQuestions.length === 0) {
                setTimeout(() => addManualQuestion(), 100);
            }
        }

        function closeModal(modalId) {
            console.log('Closing modal:', modalId);
            document.getElementById(modalId).classList.remove('active');
        }

        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            container.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 10);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function showLoading(text = 'Processing...') {
            document.getElementById('loading-text').textContent = text;
            document.getElementById('loading-overlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.remove('active');
        }

        async function handleMagicQuiz(event) {
            event.preventDefault();
            
            const topic = document.getElementById('magic-topic').value;
            const count = document.getElementById('magic-count').value;
            const difficulty = document.getElementById('magic-difficulty').value;
            const tone = document.getElementById('magic-tone').value;
            const age = document.getElementById('magic-age').value;

            // Auto-generate title
            const title = `${topic} Quiz`;

            showLoading('Generating quiz with AI...');
            closeModal('magic-modal');

            try {
                const prompt = `Create a ${difficulty} difficulty quiz with exactly ${count} multiple choice questions about: "${topic}". The quiz should have a ${tone} tone and be appropriate for someone who is ${age} years old.

Return ONLY valid JSON in this exact format:
{
  "questions": [
    {
      "question": "Question text?",
      "answers": ["Answer 1", "Answer 2", "Answer 3", "Answer 4"],
      "correct": 0
    }
  ]
}`;

                const response = await fetch(`https://text.pollinations.ai/${encodeURIComponent(prompt)}`);
                const text = await response.text();
                
                const jsonMatch = text.match(/\{[\s\S]*\}/);
                if (!jsonMatch) throw new Error('No valid JSON found');

                const quizData = JSON.parse(jsonMatch[0]);
                
                if (!quizData.questions || quizData.questions.length === 0) {
                    throw new Error('No questions generated');
                }

                // Generate thumbnail
                const thumbnailUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(topic + ' quiz education')}/width=400/height=240/nologo=true`;

                hideLoading();

                // Show preview
                currentPreviewData = {
                    title: title,
                    questions: quizData.questions,
                    ageLevel: `${age} years old`,
                    difficulty: difficulty,
                    topic: topic,
                    thumbnail: thumbnailUrl,
                    source: 'magic'
                };
                showPreview();

            } catch (error) {
                console.error('Error:', error);
                hideLoading();
                showNotification('Failed to generate quiz. Please try again.', 'error');
            }
        }

        async function handleNotesQuiz(event) {
            event.preventDefault();
            
            const notes = document.getElementById('notes-content').value;
            const count = document.getElementById('notes-count').value;
            const difficulty = document.getElementById('notes-difficulty').value;

            // Extract topic from notes (first 50 chars as fallback)
            const topicMatch = notes.substring(0, 50).trim();
            const title = `${topicMatch.substring(0, 30)}... Quiz`;

            showLoading('Analyzing notes and generating quiz...');
            closeModal('notes-modal');

            try {
                const prompt = `Based on these study notes, create a ${difficulty} ${count}-question multiple choice quiz:

"${notes}"

Return ONLY valid JSON in this exact format:
{
  "questions": [
    {
      "question": "Question text?",
      "answers": ["Answer 1", "Answer 2", "Answer 3", "Answer 4"],
      "correct": 0
    }
  ]
}`;

                const response = await fetch(`https://text.pollinations.ai/${encodeURIComponent(prompt)}`);
                const text = await response.text();
                
                const jsonMatch = text.match(/\{[\s\S]*\}/);
                if (!jsonMatch) throw new Error('No valid JSON found');

                const quizData = JSON.parse(jsonMatch[0]);
                
                if (!quizData.questions || quizData.questions.length === 0) {
                    throw new Error('No questions generated');
                }

                // Generate thumbnail from notes topic
                const thumbnailUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(topicMatch + ' education notes')}/width=400/height=240/nologo=true`;

                hideLoading();

                // Show preview
                currentPreviewData = {
                    title: title,
                    questions: quizData.questions,
                    difficulty: difficulty,
                    thumbnail: thumbnailUrl,
                    source: 'notes'
                };
                showPreview();

            } catch (error) {
                console.error('Error:', error);
                hideLoading();
                showNotification('Failed to generate quiz. Please try again.', 'error');
            }
        }

        function addManualQuestion() {
            const questionIndex = manualQuestions.length;
            manualQuestions.push({
                question: '',
                answers: ['', '', '', ''],
                correct: 0
            });

            const questionsList = document.getElementById('manual-questions-list');
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-item';
            questionDiv.id = `question-${questionIndex}`;
            
            questionDiv.innerHTML = `
                <img src="${imageUrl}" class="question-image-preview" alt="Question ${questionIndex + 1}" loading="lazy">
                <div class="question-header">
                    <span class="question-number">Question ${questionIndex + 1}</span>
                    <div class="question-actions">
                        <button type="button" class="btn btn-danger btn-small" data-question-index="${questionIndex}">
                            Remove
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Question Text</label>
                    <input type="text" id="q${questionIndex}-text" placeholder="Enter your question" required>
                </div>
                <div class="form-group">
                    <label>Answer Options (select the correct one)</label>
                    <div class="answer-option">
                        <input type="radio" name="q${questionIndex}-correct" value="0" checked>
                        <input type="text" id="q${questionIndex}-a0" placeholder="Answer 1" required>
                    </div>
                    <div class="answer-option">
                        <input type="radio" name="q${questionIndex}-correct" value="1">
                        <input type="text" id="q${questionIndex}-a1" placeholder="Answer 2" required>
                    </div>
                    <div class="answer-option">
                        <input type="radio" name="q${questionIndex}-correct" value="2">
                        <input type="text" id="q${questionIndex}-a2" placeholder="Answer 3" required>
                    </div>
                    <div class="answer-option">
                        <input type="radio" name="q${questionIndex}-correct" value="3">
                        <input type="text" id="q${questionIndex}-a3" placeholder="Answer 4" required>
                    </div>
                </div>
            `;
            
            questionsList.appendChild(questionDiv);
            
            // Add event listener to remove button
            const removeBtn = questionDiv.querySelector(`[data-question-index="${questionIndex}"]`);
            removeBtn.addEventListener('click', () => removeManualQuestion(questionIndex));
        }

        function removeManualQuestion(index) {
            const questionDiv = document.getElementById(`question-${index}`);
            if (questionDiv) {
                questionDiv.remove();
            }
            manualQuestions[index] = null;
        }

        async function saveManualQuiz() {
            const title = document.getElementById('manual-title').value;
            const ageLevel = document.getElementById('manual-age').value;
            const subject = document.getElementById('manual-subject').value;

            if (!title) {
                showNotification('Please enter a quiz title', 'error');
                return;
            }

            const questions = [];
            
            for (let i = 0; i < manualQuestions.length; i++) {
                if (manualQuestions[i] === null) continue;

                const questionText = document.getElementById(`q${i}-text`)?.value;
                if (!questionText) continue;

                const answers = [];
                for (let j = 0; j < 4; j++) {
                    const answer = document.getElementById(`q${i}-a${j}`)?.value;
                    if (!answer) {
                        showNotification(`Please fill all answers for Question ${i + 1}`, 'error');
                        return;
                    }
                    answers.push(answer);
                }

                const correctRadio = document.querySelector(`input[name="q${i}-correct"]:checked`);
                const correct = correctRadio ? parseInt(correctRadio.value) : 0;

                questions.push({
                    question: questionText,
                    answers: answers,
                    correct: correct
                });
            }

            if (questions.length === 0) {
                showNotification('Please add at least one question', 'error');
                return;
            }

            showLoading('Saving quiz...');
            closeModal('manual-modal');

            try {
                await saveQuizToFirebase({
                    title: title,
                    questions: questions,
                    ageLevel: ageLevel,
                    subject: subject,
                    source: 'manual'
                });

                hideLoading();
                showNotification('Quiz saved successfully!', 'success');
                setTimeout(() => window.location.href = 'dashboard.html', 1500);

            } catch (error) {
                console.error('Error:', error);
                hideLoading();
                showNotification('Failed to save quiz', 'error');
            }
        }

        async function saveQuizToFirebase(quizData) {
            if (!currentUser) {
                throw new Error('User not authenticated');
            }

            const quizRef = database.ref(`users/${currentUser.uid}/quizSets`).push();
            
            const fullQuizData = {
                ...quizData,
                createdAt: Date.now(),
                updatedAt: Date.now(),
                createdBy: currentUser.uid,
                thumbnail: quizData.thumbnail || ''
            };

            await quizRef.set(fullQuizData);
            return quizRef.key;
        }

        // Preview Functions
        function showPreview() {
            previewQuestions = JSON.parse(JSON.stringify(currentPreviewData.questions));
            
            document.getElementById('preview-title').value = currentPreviewData.title;
            document.getElementById('preview-thumbnail').src = currentPreviewData.thumbnail;
            
            renderPreviewQuestions();
            openModal('preview-modal');
        }

        function renderPreviewQuestions() {
            const container = document.getElementById('preview-questions-list');
            container.innerHTML = '';

            previewQuestions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-item';
                questionDiv.id = `preview-q-${index}`;
                
                // Generate image for each question
                const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(q.question + ' ' + q.answers[0])}/width=800/height=400/nologo=true`;
                
                questionDiv.innerHTML = `
                    <img src="${imageUrl}" class="question-image-preview" alt="Question ${index + 1}" loading="lazy">
                    <div class="question-header">
                        <span class="question-number">Question ${index + 1}</span>
                        <button type="button" class="btn btn-danger btn-small" data-preview-remove="${index}">Remove</button>
                    </div>
                    <div class="form-group">
                        <label>Question Text</label>
                        <input type="text" id="preview-q${index}-text" value="${q.question}" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Answers</label>
                        ${q.answers.map((ans, ansIdx) => `
                            <div class="answer-option">
                                <input type="radio" name="preview-q${index}-correct" value="${ansIdx}" ${ansIdx === q.correct ? 'checked' : ''}>
                                <input type="text" id="preview-q${index}-a${ansIdx}" value="${ans}">
                            </div>
                        `).join('')}
                    </div>
                `;
                
                container.appendChild(questionDiv);
                
                // Add remove listener
                const removeBtn = questionDiv.querySelector(`[data-preview-remove="${index}"]`);
                removeBtn.addEventListener('click', () => removePreviewQuestion(index));
            });
        }

        function addPreviewQuestion() {
            previewQuestions.push({
                question: '',
                answers: ['', '', '', ''],
                correct: 0
            });
            renderPreviewQuestions();
        }

        function removePreviewQuestion(index) {
            previewQuestions.splice(index, 1);
            renderPreviewQuestions();
        }

        function regenerateThumbnail() {
            const topic = currentPreviewData.topic || currentPreviewData.title || 'quiz';
            const newThumbnail = `https://image.pollinations.ai/prompt/${encodeURIComponent(topic + ' education quiz')}/width=400/height=240/nologo=true&seed=${Date.now()}`;
            document.getElementById('preview-thumbnail').src = newThumbnail;
            currentPreviewData.thumbnail = newThumbnail;
        }

        async function savePreviewQuiz() {
            const title = document.getElementById('preview-title').value;
            
            if (!title) {
                showNotification('Please enter a quiz title', 'error');
                return;
            }

            // Collect updated questions
            const updatedQuestions = [];
            for (let i = 0; i < previewQuestions.length; i++) {
                const questionText = document.getElementById(`preview-q${i}-text`)?.value;
                if (!questionText) continue;

                const answers = [];
                for (let j = 0; j < 4; j++) {
                    const answer = document.getElementById(`preview-q${i}-a${j}`)?.value;
                    if (!answer) {
                        showNotification(`Please fill all answers for Question ${i + 1}`, 'error');
                        return;
                    }
                    answers.push(answer);
                }

                const correctRadio = document.querySelector(`input[name="preview-q${i}-correct"]:checked`);
                const correct = correctRadio ? parseInt(correctRadio.value) : 0;

                updatedQuestions.push({
                    question: questionText,
                    answers: answers,
                    correct: correct
                });
            }

            if (updatedQuestions.length === 0) {
                showNotification('Please add at least one question', 'error');
                return;
            }

            showLoading('Saving quiz...');
            closeModal('preview-modal');

            try {
                const quizData = {
                    ...currentPreviewData,
                    title: title,
                    questions: updatedQuestions,
                    thumbnail: document.getElementById('preview-thumbnail').src
                };

                await saveQuizToFirebase(quizData);

                hideLoading();
                showNotification('Quiz saved successfully!', 'success');
                setTimeout(() => window.location.href = 'dashboard.html', 1500);

            } catch (error) {
                console.error('Error:', error);
                hideLoading();
                showNotification('Failed to save quiz', 'error');
            }
        }

        function handleGoogleFormsImport() {
            showLoading('Initializing Google Forms...');
            initializeGoogleForms();
        }

        function initializeGoogleForms() {
            if (typeof gapi === 'undefined') {
                setTimeout(initializeGoogleForms, 100);
                return;
            }

            gapi.load('client:picker', async () => {
                try {
                    await gapi.client.init({
                        apiKey: CONFIG.googleForms.apiKey,
                        discoveryDocs: ['https://forms.googleapis.com/$discovery/rest?version=v1']
                    });
                    gapiInited = true;
                    pickerApiLoaded = true;
                    hideLoading();
                    authorizeGoogleForms();
                } catch (error) {
                    console.error('Error initializing:', error);
                    hideLoading();
                    showNotification('Failed to initialize Google Forms', 'error');
                }
            });
        }

        function authorizeGoogleForms() {
            if (typeof google === 'undefined' || !google.accounts) {
                showNotification('Google API not loaded', 'error');
                return;
            }

            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CONFIG.googleForms.clientId,
                scope: CONFIG.googleForms.scopes,
                callback: async (tokenResponse) => {
                    if (tokenResponse.error) {
                        showNotification('Authorization failed', 'error');
                        return;
                    }
                    accessToken = tokenResponse.access_token;
                    createFormsPicker();
                },
            });
            tokenClient.requestAccessToken();
        }

        function createFormsPicker() {
            if (!pickerApiLoaded || typeof google === 'undefined') {
                showNotification('Picker not ready', 'error');
                return;
            }

            const view = new google.picker.DocsView(google.picker.ViewId.FORMS);
            view.setMimeTypes('application/vnd.google-apps.form');

            const picker = new google.picker.PickerBuilder()
                .enableFeature(google.picker.Feature.NAV_HIDDEN)
                .setOAuthToken(accessToken)
                .setDeveloperKey(CONFIG.googleForms.apiKey)
                .addView(view)
                .setCallback(handleFormSelection)
                .build();
            picker.setVisible(true);
        }

        async function handleFormSelection(data) {
            if (data.action === google.picker.Action.PICKED) {
                const formId = data.docs[0].id;
                showLoading('Importing form...');

                try {
                    const response = await fetch(`https://forms.googleapis.com/v1/forms/${formId}`, {
                        headers: { Authorization: `Bearer ${accessToken}` }
                    });

                    if (!response.ok) {
                        throw new Error('Failed to fetch form');
                    }

                    const formData = await response.json();
                    const convertedQuiz = convertGoogleFormToPolor(formData);

                    if (convertedQuiz.questions.length === 0) {
                        throw new Error('No valid multiple choice questions found in form');
                    }

                    await saveQuizToFirebase(convertedQuiz);

                    hideLoading();
                    showNotification('Form imported successfully!', 'success');
                    setTimeout(() => window.location.href = 'dashboard.html', 1500);

                } catch (error) {
                    console.error('Import error:', error);
                    hideLoading();
                    showNotification(error.message || 'Failed to import form', 'error');
                }
            } else if (data.action === google.picker.Action.CANCEL) {
                showNotification('Import cancelled', 'info');
            }
        }

        function convertGoogleFormToPolor(formData) {
            const questions = [];

            if (formData.items) {
                formData.items.forEach(item => {
                    if (item.questionItem) {
                        const question = item.questionItem.question;
                        
                        if (question.choiceQuestion) {
                            const choices = question.choiceQuestion.options || [];
                            if (choices.length >= 2) {
                                const answers = choices.map(choice => choice.value);
                                
                                let correct = 0;
                                if (question.grading && question.grading.correctAnswers) {
                                    const correctAnswer = question.grading.correctAnswers.answers[0]?.value;
                                    correct = answers.indexOf(correctAnswer);
                                    if (correct === -1) correct = 0;
                                }

                                questions.push({
                                    question: item.title || 'Untitled Question',
                                    answers: answers.slice(0, 4),
                                    correct: correct
                                });
                            }
                        }
                    }
                });
            }

            return {
                title: formData.info?.title || 'Imported Quiz',
                questions: questions,
                source: 'google-forms',
                originalFormId: formData.formId
            };
        }

        // Check for edit mode
        const urlParams = new URLSearchParams(window.location.search);
        const editQuizId = urlParams.get('edit');
        
        if (editQuizId) {
            auth.onAuthStateChanged(user => {
                if (user) {
                    loadQuizForEditing(editQuizId);
                }
            });
        }

        async function loadQuizForEditing(quizId) {
            showLoading('Loading quiz...');
            
            try {
                const snapshot = await database.ref(`users/${currentUser.uid}/quizSets/${quizId}`).once('value');
                const quizData = snapshot.val();
                
                if (!quizData) {
                    throw new Error('Quiz not found');
                }

                openModal('manual-modal');
                document.getElementById('manual-title').value = quizData.title || '';
                document.getElementById('manual-age').value = quizData.ageLevel || 'High School';
                document.getElementById('manual-subject').value = quizData.subject || '';

                manualQuestions = [];
                document.getElementById('manual-questions-list').innerHTML = '';

                if (quizData.questions) {
                    quizData.questions.forEach((q, index) => {
                        addManualQuestion();
                        setTimeout(() => {
                            const questionText = document.getElementById(`q${index}-text`);
                            if (questionText) {
                                questionText.value = q.question;
                                // Update image based on question
                                const img = document.querySelector(`#question-${index} .question-image-preview`);
                                if (img && q.question) {
                                    img.src = `https://image.pollinations.ai/prompt/${encodeURIComponent(q.question + ' ' + q.answers[0])}/width=800/height=400/nologo=true`;
                                }
                            }
                            q.answers.forEach((ans, ansIndex) => {
                                const ansInput = document.getElementById(`q${index}-a${ansIndex}`);
                                if (ansInput) ansInput.value = ans;
                            });
                            const correctRadio = document.querySelector(`input[name="q${index}-correct"][value="${q.correct}"]`);
                            if (correctRadio) correctRadio.checked = true;
                        }, 100 * index);
                    });
                }

                hideLoading();
                showNotification('Quiz loaded for editing', 'success');

            } catch (error) {
                console.error('Error loading quiz:', error);
                hideLoading();
                showNotification('Failed to load quiz', 'error');
                window.location.href = 'dashboard.html';
            }
        }
    </script>
</body>
</html>